name: OpenWRT IPQ807x Kernel 6.12 Build

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/LiBwrt/openwrt-6.x.git
  REPO_BRANCH: kernel-6.12
  CONFIG_FILE: configs/ipq807x.config
  DIY_SCRIPT: diy-script.sh
  CLASH_KERNEL: amd64
  CACHE_TOOLCHAIN: true
  UPLOAD_BIN_DIR: false
  FIRMWARE_RELEASE: true
  FIRMWARE_TAG: IPQ807x-WIFI
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # 1ï¸âƒ£ é…ç½®ç¼–è¯‘ç¯å¢ƒ
      - name: Setup Build Environment
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk \
            gettext git libncurses-dev libssl-dev python3 python3-pip python3-distutils \
            rsync unzip zlib1g-dev file wget curl cpio \
            gcc-11-aarch64-linux-gnu g++-11-aarch64-linux-gnu quilt

      #  3ï¸âƒ£æ£€å‡ºæºç 
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          ref: kernel-6.12
          fetch-depth: 0
          submodules: true

      - name: Clone Source Code(å…‹éš†æºä»£ç )
        run: |
          df -hT $GITHUB_WORKSPACE
          git clone $REPO_URL -b $REPO_BRANCH openwrt
          cd openwrt
          echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
          VERSION_INFO=$(git show -s --date=short --format="ä½œè€…: %an<br/>æ—¶é—´: %cd<br/>å†…å®¹: %s<br/>hash: %H")
          echo "VERSION_INFO=$VERSION_INFO" >> $GITHUB_ENV

      # 2ï¸âƒ£ æ˜¾å¼è¿›å…¥æºç ç›®å½•ï¼Œæ£€æŸ¥è·¯å¾„
      - name: Enter Source Directory
        run: |
          echo "å½“å‰ç›®å½•: $(pwd)"
          ls -lh
          cd ${{ github.workspace }}
          ls -lh


      # 4ï¸âƒ£ æ›´æ–° feeds
      - name: Update Feeds
        run: |
          cd ${{ github.workspace }}
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 5ï¸âƒ£ åº”ç”¨å†…æ ¸è¡¥ä¸
      - name: Apply Kernel Patches
        run: |
          cd ${{ github.workspace }}
          make target/linux/clean
          make target/linux/prepare V=s QUILT=1
          
          # éªŒè¯è¡¥ä¸æ˜¯å¦æˆåŠŸåº”ç”¨
          cd build_dir/target-*/linux-ipq807x/linux-6.12
          echo "âœ… Applied patches:"
          quilt applied || true
          echo "ğŸ“„ All patches:"
          quilt series || true

      # 6ï¸âƒ£ ç¼–è¯‘å›ºä»¶
      - name: Compile Firmware
        run: |
          cd ${{ github.workspace }}
          make -j$(nproc) V=s

      # 7ï¸âƒ£ æ‰“åŒ…å›ºä»¶
      - name: Package Firmware
        run: |
          mkdir -p output
          cp -r bin/targets/ipq807x/generic/* output/
          cd output
          tar -czvf openwrt-ipq807x-firmware.tar.gz *

      # 8ï¸âƒ£ ä¸Šä¼ å›ºä»¶
      - name: Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-ipq807x-firmware
          path: output/openwrt-ipq807x-firmware.tar.gz
